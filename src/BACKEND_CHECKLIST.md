# Backend Integration Checklist

Use this checklist to ensure your backend is properly set up for the Echoes frontend.

## âœ… Required Backend Endpoints

Your FastAPI backend must implement these endpoints:

### 1. Health Check âœ“
```python
@app.get("/health")
async def health():
    return {"status": "ok"}
```

**Test:**
```bash
curl http://localhost:8000/health
```

---

### 2. Embed Text âœ“
```python
@app.post("/embed")
async def embed(request: EmbedRequest):
    # Returns embedding vector for input text
    return {"embedding": [...]}
```

**Test:**
```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{"text":"freedom and liberty"}'
```

---

### 3. Get Timeline âœ“
```python
@app.get("/timeline")
async def timeline(concept: str, top_n: int = 5):
    return {
        "concept": concept,
        "eras": [
            {
                "era": "1900s",
                "items": [{"text": "...", "similarity": 0.89}],
                "centroid": [...]
            }
        ],
        "semantic_shift": 35.5,
        "primary_association": {
            "from": "...",
            "to": "..."
        }
    }
```

**Test:**
```bash
curl "http://localhost:8000/timeline?concept=freedom&top_n=5"
```

---

### 4. Get Era Data âœ“
```python
@app.get("/era")
async def era(concept: str, era: str, top_n: int = 10):
    return {
        "concept": concept,
        "era": era,
        "items": [{"text": "...", "similarity": 0.89}]
    }
```

**Test:**
```bash
curl "http://localhost:8000/era?concept=freedom&era=1900s&top_n=10"
```

---

### 5. Get Symbol Pairs âœ“
```python
@app.get("/symbol-pairs")
async def symbol_pairs(symbol: str):
    return {
        "symbol": symbol,
        "pairs": {
            "1900s": {
                "ancient": {
                    "path": "/assets/symbols/freedom/1900s_ancient.jpg",
                    "title": "Liberty Bell",
                    "description": "Symbol of independence",
                    "era": "1753"
                },
                "modern": {...}
            }
        }
    }
```

**Test:**
```bash
curl "http://localhost:8000/symbol-pairs?symbol=freedom"
```

---

## ğŸ“ Required File Structure

```
echoes-backend/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ main.py              âœ“ FastAPI app with endpoints
â”‚   â”œâ”€â”€ utils.py             âœ“ Helper functions
â”‚   â””â”€â”€ models.py            âœ“ Pydantic models
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ 1900s_freedom.csv    âœ“ Historical text data
â”‚   â””â”€â”€ 2020s_freedom.csv    âœ“ Modern text data
â”‚
â”œâ”€â”€ embeddings/              âœ“ Generated by build script
â”‚   â””â”€â”€ freedom/
â”‚       â”œâ”€â”€ 1900s.json       
â”‚       â””â”€â”€ 2020s.json
â”‚
â”œâ”€â”€ assets/                  âš ï¸ Optional
â”‚   â””â”€â”€ symbols/
â”‚       â””â”€â”€ freedom/
â”‚           â”œâ”€â”€ 1900s_ancient.jpg
â”‚           â”œâ”€â”€ 1900s_modern.jpg
â”‚           â”œâ”€â”€ 2020s_ancient.jpg
â”‚           â””â”€â”€ 2020s_modern.jpg
â”‚
â””â”€â”€ scripts/
    â””â”€â”€ build_embeddings.py  âœ“ Generate embeddings
```

---

## ğŸ”§ CORS Configuration

**Critical for frontend to connect!**

```python
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",              # Local dev
        "https://your-frontend.vercel.app"    # Production
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## ğŸ“Š Data Format Requirements

### CSV Files
```csv
text,year,source
"example text about concept",1920,"source name"
"another related text",1925,"different source"
```

**Requirements:**
- Must have `text` column
- Optional: `year`, `source`, `metadata`
- UTF-8 encoding

---

### Embeddings JSON
```json
{
  "items": [
    {
      "text": "example text",
      "embedding": [0.1, 0.2, 0.3, ...],
      "similarity": 0.89,
      "metadata": {}
    }
  ],
  "centroid": [0.1, 0.2, 0.3, ...]
}
```

**Generated by:** `build_embeddings.py`

---

## âš™ï¸ Environment Setup

### Python Dependencies

**Minimum required:**
```txt
fastapi
uvicorn[standard]
sentence-transformers
torch
numpy
pandas
scikit-learn
```

**Install:**
```bash
pip install -r requirements.txt
```

---

### Build Embeddings

**Before first run:**
```bash
python scripts/build_embeddings.py --concept freedom --eras 1900s,2020s
```

**This creates:**
- `embeddings/freedom/1900s.json`
- `embeddings/freedom/2020s.json`

---

## ğŸ§ª Testing Backend

### Full Integration Test

```bash
# 1. Start server
uvicorn api.main:app --reload --port 8000

# 2. Test health
curl http://localhost:8000/health

# 3. Test timeline
curl "http://localhost:8000/timeline?concept=freedom&top_n=5"

# 4. Test era
curl "http://localhost:8000/era?concept=freedom&era=1900s&top_n=10"

# 5. Test symbols (optional)
curl "http://localhost:8000/symbol-pairs?symbol=freedom"
```

**All should return JSON without errors!**

---

## ğŸš¨ Common Issues

### âŒ ModuleNotFoundError

```bash
# Solution: Install dependencies
pip install -r requirements.txt
```

### âŒ "Embeddings not found"

```bash
# Solution: Generate embeddings
python scripts/build_embeddings.py --concept freedom --eras 1900s,2020s
```

### âŒ CORS errors in browser

```python
# Solution: Add CORS middleware (see above)
app.add_middleware(CORSMiddleware, ...)
```

### âŒ Port already in use

```bash
# Solution: Use different port
uvicorn api.main:app --reload --port 8001

# Update frontend .env:
VITE_API_URL=http://localhost:8001
```

---

## ğŸ“ Response Format Examples

### Timeline Response
```json
{
  "concept": "freedom",
  "eras": [
    {
      "era": "1900s",
      "items": [
        {"text": "liberty", "similarity": 0.89},
        {"text": "independence", "similarity": 0.85}
      ],
      "centroid": [0.1, 0.2, ...]
    },
    {
      "era": "2020s",
      "items": [
        {"text": "privacy", "similarity": 0.92},
        {"text": "autonomy", "similarity": 0.88}
      ],
      "centroid": [0.3, 0.4, ...]
    }
  ],
  "semantic_shift": 35.5,
  "primary_association": {
    "from": "national independence",
    "to": "digital autonomy"
  }
}
```

### Era Response
```json
{
  "concept": "freedom",
  "era": "1900s",
  "items": [
    {"text": "liberty and rights", "similarity": 0.89},
    {"text": "independence movement", "similarity": 0.85},
    {"text": "democratic values", "similarity": 0.82}
  ]
}
```

---

## âœ¨ Optional Enhancements

### Add Caching
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_embeddings(concept: str, era: str):
    # Cached for performance
    ...
```

### Add Logging
```python
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

@app.get("/timeline")
async def timeline(concept: str, top_n: int = 5):
    logger.info(f"Timeline request: {concept}")
    ...
```

### Static File Serving
```python
from fastapi.staticfiles import StaticFiles

app.mount("/assets", StaticFiles(directory="assets"), name="assets")
```

---

## ğŸ¯ Pre-Flight Checklist

Before connecting frontend:

- [ ] FastAPI server starts without errors
- [ ] `/health` endpoint returns `{"status":"ok"}`
- [ ] Embeddings generated for at least one concept
- [ ] CORS middleware configured
- [ ] `/timeline` returns valid JSON
- [ ] `/era` returns valid JSON
- [ ] Server running on expected port (8000)
- [ ] No authentication blocking requests

---

## ğŸš€ Production Deployment

### Environment Variables
```bash
export PORT=8000
export ALLOWED_ORIGINS="https://your-frontend.vercel.app"
```

### Dockerfile Example
```dockerfile
FROM python:3.10

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## ğŸ“ Frontend Connection Test

Once backend is ready:

1. Start frontend: `npm run dev`
2. Check for **green "Backend Connected"** indicator
3. Search for concept with embeddings
4. Verify data loads correctly

---

**All checkboxes ticked?** Your backend is ready for the Echoes frontend! âœ…
